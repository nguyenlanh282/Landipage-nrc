<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test SePay Payment - 10,000 VND</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 8px;
      font-size: 24px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
    }
    .amount-display {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 24px;
    }
    .amount-display .label { font-size: 14px; opacity: 0.9; }
    .amount-display .value { font-size: 36px; font-weight: bold; }
    .bank-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .bank-info h3 { color: #333; margin-bottom: 12px; font-size: 16px; }
    .bank-info p { color: #555; font-size: 14px; margin-bottom: 8px; }
    .bank-info strong { color: #333; }
    .qr-container {
      text-align: center;
      margin-bottom: 24px;
    }
    .qr-container img {
      max-width: 280px;
      border-radius: 12px;
      border: 4px solid #eee;
    }
    .order-code {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      margin-bottom: 24px;
    }
    .order-code .label { font-size: 12px; color: #856404; }
    .order-code .code { font-size: 20px; font-weight: bold; color: #856404; letter-spacing: 2px; }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .status {
      text-align: center;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
    }
    .status.checking { background: #e3f2fd; color: #1976d2; display: block; }
    .status.success { background: #e8f5e9; color: #2e7d32; display: block; }
    .status.error { background: #ffebee; color: #c62828; display: block; }
    .countdown {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #764ba2;
      margin-bottom: 16px;
    }
    .instructions {
      background: #f0f4ff;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
    }
    .instructions h4 { color: #333; margin-bottom: 12px; font-size: 14px; }
    .instructions ol { color: #555; font-size: 13px; padding-left: 20px; }
    .instructions li { margin-bottom: 6px; }
    .copy-btn {
      background: #e9ecef;
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
    }
    .copy-btn:hover { background: #dee2e6; }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .checking-animation { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test SePay Payment</h1>
    <p class="subtitle">Trang test thanh toan tu dong voi tai khoan ca nhan</p>

    <div class="amount-display">
      <div class="label">So tien thanh toan</div>
      <div class="value">10,000d</div>
    </div>

    <div class="order-code">
      <div class="label">Noi dung chuyen khoan (BAT BUOC)</div>
      <div class="code" id="order-code">TEST000000</div>
      <button class="copy-btn" onclick="copyOrderCode()">Copy</button>
    </div>

    <div class="qr-container">
      <img id="qr-image" src="" alt="QR Code thanh toan">
    </div>

    <div class="bank-info">
      <h3>Thong tin chuyen khoan</h3>
      <p>Ngan hang: <strong>MB Bank</strong></p>
      <p>So tai khoan: <strong>86886799799</strong> <button class="copy-btn" onclick="copyText('86886799799')">Copy</button></p>
      <p>Chu tai khoan: <strong>NGUYEN VAN TEST</strong></p>
    </div>

    <div class="countdown" id="countdown">15:00</div>

    <div class="status" id="status"></div>

    <button class="btn btn-primary" id="check-btn" onclick="checkPayment()">
      Kiem tra thanh toan
    </button>

    <div class="instructions">
      <h4>Huong dan:</h4>
      <ol>
        <li>Mo app ngan hang (MB Bank, VietcomBank, BIDV...)</li>
        <li>Quet ma QR hoac chuyen khoan thu cong</li>
        <li><strong>QUAN TRONG:</strong> Nhap noi dung chuyen khoan chinh xac</li>
        <li>Xac nhan thanh toan</li>
        <li>He thong se tu dong xac nhan sau 5-10 giay</li>
      </ol>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      accountNumber: '86886799799',
      bankCode: 'mbbank',
      amount: 10000,
      orderPrefix: 'TEST',
      workerUrl: 'https://sepay-payment-gateway.it-nguyenlanh.workers.dev'
    };

    // Generate order code
    function generateOrderCode() {
      const timestamp = Date.now().toString().slice(-6);
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `${CONFIG.orderPrefix}${timestamp}${random}`;
    }

    // Build QR URL
    function buildQRUrl(orderCode) {
      const params = new URLSearchParams({
        acc: CONFIG.accountNumber,
        bank: CONFIG.bankCode,
        amount: CONFIG.amount.toString(),
        des: orderCode
      });
      return `https://qr.sepay.vn/img?${params.toString()}`;
    }

    // Initialize
    const orderCode = generateOrderCode();
    document.getElementById('order-code').textContent = orderCode;
    document.getElementById('qr-image').src = buildQRUrl(orderCode);

    // Countdown
    let timeLeft = 15 * 60; // 15 minutes
    const countdownEl = document.getElementById('countdown');

    function updateCountdown() {
      const mins = Math.floor(timeLeft / 60);
      const secs = timeLeft % 60;
      countdownEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

      if (timeLeft <= 60) {
        countdownEl.style.color = '#c62828';
      }

      if (timeLeft > 0) {
        timeLeft--;
        setTimeout(updateCountdown, 1000);
      } else {
        countdownEl.textContent = 'Het thoi gian!';
      }
    }
    updateCountdown();

    // Auto check payment every 10 seconds
    let checkInterval = null;
    let isChecking = false;

    function startAutoCheck() {
      checkInterval = setInterval(checkPayment, 10000);
      // First check after 5 seconds
      setTimeout(checkPayment, 5000);
    }

    async function checkPayment() {
      if (isChecking) return;
      isChecking = true;

      const statusEl = document.getElementById('status');
      const checkBtn = document.getElementById('check-btn');

      statusEl.className = 'status checking checking-animation';
      statusEl.textContent = 'Dang kiem tra thanh toan...';
      checkBtn.disabled = true;
      checkBtn.textContent = 'Dang kiem tra...';

      try {
        const response = await fetch(`${CONFIG.workerUrl}/check-payment?code=${orderCode}`);
        const data = await response.json();

        console.log('Payment check result:', data);

        if (data.paid) {
          // Payment confirmed!
          clearInterval(checkInterval);
          statusEl.className = 'status success';
          statusEl.innerHTML = `
            <strong>THANH TOAN THANH CONG!</strong><br>
            So tien: ${new Intl.NumberFormat('vi-VN').format(data.amount)}d<br>
            Thoi gian: ${new Date(data.paidAt).toLocaleString('vi-VN')}<br>
            Transaction ID: ${data.transactionId || 'N/A'}
          `;
          checkBtn.className = 'btn btn-success';
          checkBtn.textContent = 'DA THANH TOAN';
          checkBtn.disabled = true;
        } else {
          statusEl.className = 'status';
          statusEl.style.display = 'block';
          statusEl.style.background = '#fff3e0';
          statusEl.style.color = '#e65100';
          statusEl.textContent = 'Chua nhan duoc thanh toan. Thu lai sau 10 giay...';
          checkBtn.disabled = false;
          checkBtn.textContent = 'Kiem tra thanh toan';
        }
      } catch (error) {
        console.error('Check payment error:', error);
        statusEl.className = 'status error';
        statusEl.textContent = 'Loi ket noi. Vui long thu lai.';
        checkBtn.disabled = false;
        checkBtn.textContent = 'Kiem tra thanh toan';
      }

      isChecking = false;
    }

    // Copy functions
    function copyOrderCode() {
      copyText(orderCode);
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Da copy: ' + text);
      }).catch(() => {
        // Fallback
        const input = document.createElement('input');
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('Da copy: ' + text);
      });
    }

    // Start auto check
    startAutoCheck();

    // Register payment with worker
    fetch(`${CONFIG.workerUrl}/register-payment`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderCode: orderCode,
        shopId: 'test',
        amount: CONFIG.amount
      })
    }).then(r => r.json()).then(data => {
      console.log('Payment registered:', data);
    }).catch(err => {
      console.log('Register payment error:', err);
    });
  </script>
</body>
</html>
